#!/bin/sh
PREREQ=""
prereqs()
{
        echo "$PREREQ"
}
case $1 in
prereqs)
        prereqs
        exit 0
        ;;
esac

PROFILE="profile init-systemd /lib/systemd/** flags=(complain) 
{

	/lib/netplan/generate cx -> netplan_profile,

	/usr/lib/systemd/system-environment-generators/snapd-env-generator cx -> snapd_env_generator,

	capability audit_write,	
	capability dac_override,
	capability dac_read_search,
	capability kill,
	capability mknod,
	capability net_admin,
	capability setuid,
	capability sys_admin,
	capability sys_boot,
	capability sys_module,
	capability sys_ptrace,
	capability sys_resource,
	capability sys_time,
	capability sys_tty_config,

	/dev/** rw,
	/etc/**	r,
	
	/lib/systemd/** rix,
	/lib/** rm,

	mount, 

	/proc/** rw,
	ptrace, 


	/run/**	rwcx -> run_default,
	signal, 

	/sys/** rwcx -> sys_default,
	
	/usr/ r,
	/{,usr/}{,s}bin/* rcx -> default_profile,
	/usr/lib/x86_64-linux-gnu/**	rm,
	/usr/** rw,
	/var/** rw,
	/tmp/** rw,
	

	profile run_default flags=(complain){

	}

	profile sys_default flags=(complain){

	}
	
	profile default_profile flags=(complain){

		/{,usr/}{,s}bin/* r, 
		/dev/null	rw,
		/etc/ld.so.cache	r,
		/etc/locale.alias	r,
		/lib/netplan/generate mr,
		/lib/x86_64-linux-gnu/*.so mr,
		/lib/x86_64-linux-gnu/*.so.* mr,
		/proc/**	r,
		/run/systemd/generator/openvpn.service.wants/	rw,
		/run/systemd/generator/openvpn.service.wants/**	rw,
		/usr/lib/locale/**	r,
		/usr/lib/x86_64-linux-gnu/*.so.* rm,
	}
	profile netplan_profile flags=(complain) {
		capability mknod,
		/bin/udevadm	rix,
		/dev/null	rw,
		/etc/ld.so.cache	r,
		/etc/netplan/	r,
		/etc/netplan/**	r,
		/etc/udev/** r,
		/lib/netplan/	r,
		/lib/netplan/generate mrix,
		/lib/systemd/system-generators/netplan	mrix,
		/lib/x86_64-linux-gnu/*.so mr,
		/lib/x86_64-linux-gnu/*.so.* mr,
		/proc/** r,
		ptrace,
		/run/NetworkManager/ rw,
		/run/NetworkManager/** rw,
		/run/systemd/** rw,
		/usr/lib/x86_64-linux-gnu/*.so.* rm,
	}
	profile snapd_env_generator flags=(complain) {
		/dev/null	rw,
		/etc/ld.so.cache	r, 
		/lib/x86_64-linux-gnu/*.so mr,
		/lib/x86_64-linux-gnu/*.so.* mr,
		/usr/lib/systemd/system-environment-generators/snapd-env-generator mr,
	}
}"

mount -t securityfs none /sys/kernel/security
#echo "profile init-systemd /lib/systemd/** flags=(complain) {/lib/systemd/* ix, /{,usr/}{,s}bin/* pix, /opt/** Px,}" | /sbin/apparmor_parser -a
#echo "profile init-upstart /sbin/upstart flags=(complain) {}" | /sbin/apparmor_parser -a

echo "$PROFILE" | /sbin/apparmor_parser -a
#echo "profile init-upstart /sbin/upstart flags=(complain) {}" | /sbin/apparmor_parser -a

read -p "Enter a name: " name
echo "Hi, $name"
