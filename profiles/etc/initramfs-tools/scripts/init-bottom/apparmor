#!/bin/sh
PREREQ=""
prereqs()
{
        echo "$PREREQ"
}
case $1 in
prereqs)
        prereqs
        exit 0
        ;;
esac

PROFILE="profile init-systemd /lib/systemd/** flags=(complain) 
{
	/bin/*  cx -> binprofile,
	
	/etc/init.d/network-manager cx -> networkmanager,

	/lib/netplan/generate cx -> netplan,
	/lib/systemd/systemd-journald cx -> systemdjournal,


	/sbin/* cx ->  sbinprofile,	

	/usr/bin/* cx -> usrbinprofile,

	/usr/lib/colord/colord-sane cx -> usrlibprofile,
	/usr/lib/gcc/x86_64-linux-gnu/8/cc1 cx -> usrlibprofile,
	/usr/lib/gnome-online-accounts/goa-daemon cx -> usrlibprofile,
	/usr/lib/gnome-session/gnome-session-binary cx -> usrlibprofile,
	/usr/lib/gnome-settings-daemon/gsd-media-keys cx -> usrlibprofile,
	/usr/lib/gnome-settings-daemon/gsd-rfkill cx -> usrlibprofile,
	/usr/lib/gnome-settings-daemon/gsd-wacom cx -> usrlibprofile,
	/usr/lib/gvfs/gvfsd cx -> usrlibprofile,
	/usr/lib/gvfs/gvfsd-burn cx -> usrlibprofile,
	/usr/lib/gvfs/gvfs-goa-volume-monitor cx -> usrlibprofile,
	/usr/lib/ibus/ibus-x11 cx -> usrlibprofile,
	/usr/lib/snapd/snapd cx -> usrlibprofile,
	/usr/lib/systemd/system-environment-generators/snapd-env-generator cx -> usrlibprofile,
	/usr/lib/tracker/tracker-miner-apps cx -> usrlibprofile,
	/usr/lib/tracker/tracker-extract cx -> usrlibprofile,
	/usr/lib/tracker/tracker-miner-fs cx -> usrlibprofile,
	/usr/lib/tracker/tracker-store cx -> usrlibprofile,
	/usr/lib/udisks2/udisksd cx -> usrlibprofile,
	/usr/lib/x86_64-linux-gnu/glib-2.0/gio-launch-desktop cx -> usrlibprofile,
	/usr/lib/xorg/Xorg cx -> usrlibprofile,

	/usr/libexec/** rcx -> usrlibexecprofile,
	
	/usr/sbin/* cx -> usrsbinprofile,

	

    capability audit_read,
    capability audit_write, 
    capability chown,
    capability dac_override,
    capability dac_read_search,
    capability kill,
    capability mknod,
    capability net_admin,
    capability setuid,
    capability sys_admin,
    capability sys_boot,
    capability sys_module,
    capability sys_ptrace,
    capability sys_resource,
    capability sys_time,
    capability sys_tty_config,	

	/dev/** rw,
    /etc/** r,

	/lib/console-setup/keyboard-setup.sh    rmix,   
    /lib/systemd/** rix,
    /lib/** rm,
   
    mount, 
   
    /proc/** rw,
    ptrace, 
  
    /run/** rwcx -> run_default,
    signal, 
    /sys/** rwcx -> sys_default,
	/snap/** r,
	umount,
    /usr/ r,
    # /{,usr/}{,s}bin/** rmwcx -> default_profile,
    /usr/lib/x86_64-linux-gnu/**    rm,
    /usr/** rw,
    /var/** rw,
    /tmp/** rw,

	profile run_default flags=(complain){
  
    }
  
    profile sys_default flags=(complain){
   
    }
       
    profile default_profile flags=(complain){

	}

	
	profile netplan flags=(complain){
		/dev/null wr,
		/etc/ld.so.cache r,
		/lib/x86_64-linux-gnu/ld-2.29.so r,
		/lib/netplan/generate r,
		/usr/lib/** rm,

	}
	
	profile sbinprofile flags=(complain){
		capability sys_tty_config,
		/etc/apparmor.d/** r,
		/lib/x86_64-linux-gnu/libe2p.so.2.3 rm,
		/lib/x86_64-linux-gnu/libblkid.so.1.1.0 rm,
		/lib/x86_64-linux-gnu/libc-2.29.so rm,
		/usr/lib/x86_64-linux-gnu/libXext.so.6.4.0 r,
	}

	profile NetworkManager flags=(complain){
		capability,
		/etc/hosts r,
		/proc/sys/net/ipv6/conf/enp0s3/accept_ra w,
		/usr/lib/** rm,

	}

	profile systemd_journal flags=(complain){
		ptrace,
		signal,
		capability,
	}

	profile usrlibexecprofile flags=(complain){
		/usr/lib/** rm,
	}

	profile binprofile flags=(complain){
		/opt/VBoxGuestAdditions-5.2.16/src/vboxguest-5.2.16/vboxguest/include/iprt/latin1.h r,
		/bin/** rix,
		/dev/null rw,
		/etc/ld.so.cache r,
		/home/abhishek/.oh-my-zsh/** r,
		/lib/x86_64-linux-gnu/ld-2.29.so r,
		/lib/x86_64-linux-gnu/libmount.so.1.1.0 rm,
		/lib/x86_64-linux-gnu/libc-2.29.so rm,
		/lib/x86_64-linux-gnu/libblkid.so.1.1.0 r,
	    	/usr/lib/** rm,	
	}
	
	profile usrbinprofile flags=(complain){
		/bin/* cx -> binprofile,		
		/dev/shm/ r,
		/dev/urandom r,
		/dev/null r,

		/etc/pulse/client.conf r,
		/etc/pulse/client.conf.d/ r,
		/etc/pulse/client.conf.d/00-disable-autospawn.conf r,
		/etc/ld.so.cache r,
		/etc/locale.alias r,
		/etc/nsswitch.conf r,
		/etc/passwd r,
		/etc/ssl/openssl.cnf r,
		/home/abhishek/** rk,
	
		/lib/x86_64-linux-gnu/ld-2.29.so r,
		/lib/x86_64-linux-gnu/libc-2.29.so rm,
		/lib/x86_64-linux-gnu/libnss_compat-2.29.so rm,
		/lib/x86_64-linux-gnu/libnss_nis-2.29.so rm,
				
		/proc/[0-9]*/cmdline r,
		/proc/[0-9]*/oom_score_adj w,
		/run/** rw,
		
		/usr/bin/* rix,
		/usr/lib/** rmix,
		/usr/share/** r,
		/var/lib/gdm3/.config/pulse/cookie rk,
		/tmp/** rw,
	
	}
	
	profile usrsbinprofile flags=(complain){
		/dev/null r,		
		/etc/default/locale r,
		/etc/cups/** rwix,
		/proc/[0-9]*/cgroup r,
		/proc/[0-9]*/fd/ r,
		/run/systemd/** r,
		/usr/lib/** rix,
		/usr/share/** r,
		

	}
	
	profile usrlibprofile flags=(complain){
		/dev/bus/usb/ r,
		/dev/null wr,
		/dev/rfkill w,
		/etc/fonts/** r,
		/etc/locale.alias r,
		/etc/ld.so.cache r,
		/etc/sane.d/** r,
		
		/home/abhishek/.local/share/tracker/data/tracker-store.journal w,
		/home/abhishek/** rk,
		/lib/x86_64-linux-gnu/ld-2.29.so r,
		/lib/x86_64-linux-gnu/libc-2.29.so rm,
		/lib/x86_64-linux-gnu/libdevmapper.so.1.02.1 rm,

		/proc/[0-9]*/cmdline r,
		/proc/[0-9]*/fd/ r,
		/proc/filesystems r,
		/proc/version r,
				
		/run/udev/data/c189:129 r,
		/run/user/** wrix,
		/sys/bus/ r,
		/sys/bus/** r,
		/sys/devices/** r,
		/usr/lib/** rmix,
		/usr/src/** r,
		/usr/share/** r,
		/var/lib/** rk,
		/tmp/** rwix,		
		
		
	}



}"

mount -t securityfs none /sys/kernel/security
#echo "profile init-systemd /lib/systemd/** flags=(complain) {/lib/systemd/* ix, /{,usr/}{,s}bin/* pix, /opt/** Px,}" | /sbin/apparmor_parser -a
#echo "profile init-upstart /sbin/upstart flags=(complain) {}" | /sbin/apparmor_parser -a

echo "$PROFILE" | /sbin/apparmor_parser -a
#echo "profile init-upstart /sbin/upstart flags=(complain) {}" | /sbin/apparmor_parser -a

read -p "Enter a name: " name
echo "Hi, $name"
